{% extends "base.html.jinja2" %}
{% from "utils.html.jinja2" import render_alerts %}
{% block head %}
    {{ super() }}
    <meta property="og:title" content="Notifikácie o COVID-19 vakcinácii"/>
    <meta property="og:type" content="website"/>
    <meta property="og:image" content="{{ url_for('static', filename='virus.svg', _external=True) }}"/>
    <meta property="og:image:alt" content="Obrázok vírusu"/>
    <meta property="og:url" content="{{ url_for('main.spot_subscribe') }}"/>
    <meta property="og:locale" content="sk_SK"/>
    <meta property="og:description" content="Táto stránka poskytuje notifikácie na Váš email o voľných miestach na očkovanie proti COVID-19."/>
{% endblock %}
{% block content %}
    <div class="row">
        <div class="col-sm-10 mx-auto">
            <h1>Notifikácie o voľných miestach</h1>
            <p class="lead">
                Chcem dostávať notifikácie na email o voľných termínoch na očkovanie vo vybraných očkovacích miestach.
            </p>
            {{ render_alerts(get_alerts()) }}
        </div>
    </div>
    <div class="row mt-2 mb-5">
        <div class="col-sm-10 mx-auto">
            <div class="card bg-light">
                <div class="card-body">
                    <form id="spot-form" action="{{ url_for('main.spot_subscribe') }}" method="post">
                        {{ form.csrf_token }}

                        <div class="mb-3">
                            <label for="email" class="form-label">Email</label>
                            {{ form.email(class_="form-control") }}
                            <div class="form-text">Na tento email Vám budú chodiť notifikácie.</div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Mestá</label>
                            {{ form.places(size=3, field_kwargs={"class_": "form-check-input"}) }}
                            <div class="form-text">Notifikácie budete dostávať len o nových voľných termínoch vo vyznačených mestách.</div>
                        </div>
                        <input type="submit" class="btn btn-primary h-captcha" value="Odoslať" data-sitekey="{{ config["HCAPTCHA_SITEKEY"] }}" data-callback="submitForm"/>
                    </form>
                    <script type="text/javascript">
                        function submitForm(token) {
                            document.getElementById('spot-form').submit();
                        }
                    </script>
                </div>
            </div>
        </div>
    </div>
     <div class="row mb-3 anchor" id="places-table">
        <div class="col-sm-10 mx-auto">
            <h2 class="mb-3"><i class="fas fa-map-marker fa-fw"></i> Momentálne voľné očkovacie miesta</h2>
            <b>Posledná aktualizácia</b>: {{ last_stats.datetime.strftime("%d.%m.%Y %H:%M") }}<br/>

            <div class="overflow-auto mt-4">
            <table class="table">
                <thead>
                <tr>
                    <th scope="col" rowspan="2" style="border-bottom-color: currentColor;">Očkovacie miesto</th>
                    {% for month, days in dates | groupby("month") %}
                        <th scope="col" colspan="{{ days | length }}">{{ days[0].strftime("%B") }}</th>
                    {% endfor %}
                </tr>
                <tr style="background-color: white">
                    {% for date in dates %}
                        <th scope="col">{{ date.strftime("%d.") }}</th>
                    {% endfor %}
                </tr>
                </thead>
                {% for place in places %}
                    <tr>
                        <td>{{ place.title }}{% if not place.online %}
                            <i class="fas fa-exclamation-triangle" title="Očkovacie miesto nieje dostupné."
                               data-toggle="tooltip"></i>{% endif %}</td>
                        {% for day in place.days %}
                            <td class="{{ 'table-success' if place.online and day.capacity > 0 and day.open else 'table-danger' }}">
                            {% if day.capacity > 0 %}
                                {{ day.capacity }}
                            {% elif day.capacity < 0 %}
                                <span title="Počet termínov reportovaný od NCZI je záporný ({{ day.capacity }})." data-toggle="tooltip">0*</span>
                            {% else %}
                                0
                            {% endif %}
                            </td>
                        {% endfor %}
                    </tr>
                {% endfor %}
            </table>
            </div>
        </div>
    </div>
{% endblock %}